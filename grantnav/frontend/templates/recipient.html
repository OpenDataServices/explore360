{% extends 'base.html' %} 
{% load frontend %} 
{% load static %} 
{% block main_content %}
<div class="layout layout--single-column">
  <main class="layout__content">
    <div class="grid grid--two-columns spacer-4">
      <div class="grid__1">
        <h1 class="funder-header text-center">
          {{ recipient.id_and_name|get_facet_org_name }}
        </h1>
      </div>
      <div class="grid grid--two-columns grid__1">
        <div class="grid__1">
          <dl class="dl-horizontal top-stats">
            <dt>Total grants</dt>
            <dd>{{results.hits.total|get_amount}}</dd>
            <dt>Total funders</dt>
            <dd>{{results.aggregations.funder_orgs.value|get_amount}}</dd>
            <dt>Earliest award date</dt>
            <dd>
              {{results.aggregations.min_date.value_as_string|get_date}}
            </dd>
            <dt>Latest award date</dt>
            <dd>
              {{results.aggregations.max_date.value_as_string|get_date}}
            </dd>
          </dl>
        </div>
        <div class="grid__1">
          {% include 'currency_stats.html' %}
        </div>
      </div>
    </div>
    <div class="spacer-4">
      <div class="panel panel-info">
        <div class="panel-heading grantnav-datatable__content--filters">
          Grants
          <div class="export-wrapper">
            <div class="export-label">Export table data:</div>
            <div class="export-button">
              {% include 'components/export-data-button--csv.html' with data_function='recipient.csv' only %}
            </div>

            <div class="export-button">
              {% include 'components/export-data-button--json.html' with data_function='recipient.json' only %}
            </div>
          </div>
        </div>
        <div class="panel-body">
          <div class="table table--zebra">
            <table id="grants_datatable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Funder</th>
                  <th>Title</th>
                  <th>Description</th>
                </tr>
              </thead>
            </table>
          </div>
        </div>
      </div>
    </div>

    {% endblock %}  
    {% block extra_scripts %}
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/1.10.10/js/dataTables.bootstrap.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/responsive/2.0.2/js/dataTables.responsive.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/scroller/1.4.1/js/dataTables.scroller.min.js"
    ></script>

    <script>
      function truncate(string, len) {
        if (string.length > len) return string.substring(0, len) + "...";
        else return string;
      }

      jQuery(function ($) {
        $("#grants_datatable").dataTable({
          serverSide: true,
          responsive: true,
          searching: true,
          autoWidth: false,
          scrollY: 400,
          scroller: true,
          dom: "fit",
          scroller: { displayBuffer: 20, loadingIndicator: true },
          order: [[0, "desc"]],
          language: {
            info: "_START_ to _END_ of _TOTAL_",
            search: "Search All Fields",
          },
          ajax: {
            url: "{% url 'grants_datatables' %}",
            data: function (d) {
              d.recipient = "{{recipient.id|escapejs}}";
            },
          },
          columns: [
            { data: "awardDate" },
            { data: "amountAwarded", className: "amount" },
            {
              data: "fundingOrganization.0.name",
              render: function (data, type, row) {
                return (
                  '<a href="/funder/' +
                  encodeURIComponent(row.fundingOrganization[0].id) +
                  '">' +
                  truncate(data, 60) +
                  "</a>"
                );
              },
            },
            {
              data: "title",
              orderable: false,
              render: function (data, type, row) {
                return (
                  '<a href="/grant/' +
                  encodeURIComponent(row.id) +
                  '">' +
                  truncate(data, 60) +
                  "</a>"
                );
              },
            },
            { data: "description" },
          ],
        });
      });
    </script>
    {% endblock %} {% block models %} {% include 'currency_stats_modal.html' %}
    {% endblock %}
  </main>
</div>
