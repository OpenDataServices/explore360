{% load get_current_sort from frontend %}

<script type="text/javascript" src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
<script type="text/javascript"
  src="https://cdn.datatables.net/responsive/2.0.2/js/dataTables.responsive.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/scroller/1.4.1/js/dataTables.scroller.min.js"></script>

{% include 'widgets/grantnav_link_script.html' %}

<script>
  $(window).resize(function () {
    $('#search_grants_datatable').DataTable().responsive.recalc();
    $('#search_grants_datatable').DataTable().columns.adjust();
  });

  function truncate (string, len) {
    if (string.length > len) { return string.substring(0, len) + '...'; } else { return string; }
  }

  function getSortValue () {
    switch ('{{ query|get_current_sort }}') {
      case '_score desc':
        return [[0, 'desc']];
      case 'amountAwarded desc':
        return [[1, 'desc']];
      case 'amountAwarded asc':
        return [[1, 'asc']];
      case 'awardDate desc':
        return [[2, 'desc']];
      case 'awardDate asc':
        return [[2, 'asc']];
      default:
        return [[0, 'desc']];
    }
  }

  jQuery(function ($) {
    $('#search_grants_datatable').dataTable({
      serverSide: true,
      responsive: true,
      searching: false,
      autoWidth: true,
      scrollY: 400,
      order: getSortValue(),
      dom: 'fit',
      scroller: {
        displayBuffer: 20,
        loadingIndicator: true
      },
      language: {
        info: '_START_ to _END_ of _TOTAL_'
      },
      ajax: {
        url: "{% url 'widgets.api' %}" + window.location.search
      },
      columns: [
        {
          data: 'title',
          render: function (data, type, row) {
            return '<a href="/grant/' + encodeURIComponent(row.id) + '">' + truncate(data, 40) + '</a>';
          },
          orderable: false
        },
        { data: 'amountAwarded', className: 'amount', orderable: false },
        { data: 'awardDate', orderable: false },
        { data: 'fundingOrganization.0.name', render: function (data, type, row) { return '<a href="/org/' + row.fundingOrganization[0].id + '">' + truncate(data, 30) + '</a>'; }, orderable: false },
        { data: 'recipientOrganization.0.name', render: function (data, type, row) { return '<a href="/org/' + row.recipientOrganization[0].id + '">' + truncate(data || row.recipientOrganization[0].id, 30) + '</a>'; }, orderable: false },
        { data: 'description', orderable: false }
      ]
    });
  });
</script>
